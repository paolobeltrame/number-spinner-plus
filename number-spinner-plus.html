<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/number-spinner-validator-plus/number-spinner-validator-plus.html">
<link rel="import" href="../bower_components/message-container/message-container.html">
<script src="bower_components/d3/d3.js"></script>

<!--
`number-spinner-plus`


@demo demo/index.html
-->

<dom-module id="number-spinner-plus">
  <template>
<!--

  STYLE PROPRETIES

-->
    <style>

        :host {
            display: block;
            --number-spinner-color:red;
            /* FOR MODIFY MESSAGE CONTAINER PROPRETIES
            --number-spinner-message-text-size:size;

            --number-spinner-error-text-color:color;
            --number-spinner-error-background-color:color;
            --number-spinner-error-border-left:size type color;
            --number-spinner-error-box-shadow: see: http://www.w3schools.com/cssref/css3_pr_box-shadow.asp

            --number-spinner-ok-text-color:color;
            --number-spinner-ok-background-color:color;
            --number-spinner-ok-border-left:size type color;
            --number-spinner-ok-box-shadow: see: http://www.w3schools.com/cssref/css3_pr_box-shadow.asp

            --number-spinner-warning-text-color:color;
            --number-spinner-warning-background-color:color;
            --number-spinner-warning-border-left:size type color;
            --number-spinner-warning-box-shadow: http://www.w3schools.com/cssref/css3_pr_box-shadow.asp
            */

            /*UNSELECT BUTTON*/
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none; 
            
            width:fit-content;
        }

        message-container {
            --message-container-text-size:var(--number-spinner-message-text-size);
            
            /*ERROR MESSAGE PROPERTIES*/
            --message-container-error-text-color:var(--number-spinner-error-text-color);
            --message-container-error-background-color:var(--number-spinner-error-background-color);
            --message-container-error-border-left:var(--number-spinner-error-border-left);
            --message-container-error-box-shadow:var(--number-spinner-error-box-shadow);              

            /*OK MESSAGE PROPERTIES*/
            --message-container-ok-text-color:var(--number-spinner-ok-text-color);
            --message-container-ok-background-color:var(--number-spinner-ok-background-color);
            --message-container-ok-border-left:var(--number-spinner-ok-border-left);
            --message-container-ok-box-shadow:var(--number-spinner-ok-box-shadow);             
           
            /* WARNING MESSAGE PROPERTIES*/
            --message-container-warning-text-color:var(--number-spinner-warning-text-color);
            --message-container-warning-background-color:var(--number-spinner-warning-background-color);
            --message-container-warning-border-left:var(--number-spinner-warning-border-left);
            --message-container-warning-box-shadow:var(--number-spinner-warning-box-shadow);      
        }

        .rowSpinner {
          width: 100%;
          @apply(--layout-horizontal);
        }
        .columnSpinner {
          width: 50%;
          @apply(--layout-horizontal);
        }

        /*SPINNER CONTAINER PROPERTIES*/
        .spinnerContainer {
            @apply(--layout-vertical);
            float:right;
        }

        .right {            border-bottom:1px solid #AAAAAA;}

        .spinner {
            @apply(--layout-horizontal);
            align-items:center;

            flex-grow:1;
        }

        .spinner[active] {
            border-bottom:1px solid var(--number-spinner-color);
        }      

        /*INPUT PROPRETIES*/
        input {
            line-height:16px;
            font-size:14px;
            min-width: 160px;
            border:0px;
            text-align:right;
            user-select: none;
        }
        
        input[discrete] {
          pointer-events:none;
        }

        input:focus {
            outline: none;
            border:0px;
        }        

        /*ICON PROPERTIES*/
        iron-icon {
            height:8px;
            width:8px;
        }

        .spin {
            cursor:pointer;
        }

        /*DOWN BUTTON PROPERTIES*/
        .down {
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 6px 4px 0 4px;
            border-color: #AAAAAA transparent transparent transparent;
            
            /*UNSELECT BUTTON*/
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none; 
        }

        .down:hover {
            border-color:red transparent transparent transparent;
        }

        /*UP BUTTON PROPERTIES*/
        .up {
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 4px 6px 4px;
            border-color: transparent transparent #AAAAAA transparent;
            
            /*UNSELECT BUTTON*/
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none; 
        }

        .label {
          text-transform: lowercase;
        }

        .up:hover {
            border-color: transparent transparent red transparent;
        }
    </style>

<!--

  SPINNER IMPLEMENTATION (HTML)

--> 
    <div class="spinner" id="spinner">
        <div class="rowSpinner">
          <div class="columnSpinner">
            <div class="label">[[label]]</div>
          </div>
          <div class="columnSpinner right">
            <input id="input" is="iron-input" prevent-invalid-input allowed-pattern="[0-9.+-]"  on-keyup="_controlValueInserted" value="{{value::change}}" on-focus="_openDropdown" on-focusout="_closeDropdown" discrete$="[[discrete]]">
            <div style="width:8px"></div>
            <div class="spinnerContainer">
                <div><div class="spin up" on-tap="_up" on-mouseout="_closeDropdown"></div></div>
                <div style="height:2px;"></div>
                <div><div class="spin down" on-tap="_down" on-mouseout="_closeDropdown"></div></div>
            </div>
          </div>
        </div>
    </div>    
    <number-spinner-validator-plus
      id="numberSpinnerValidatorPlus"
      value="{{value}}"
      allowed-numbers="[[values]]" 
      min-error="[[min]]" 
      max-error="[[max]]" 
      step-warning="[[step]]"
      error-flag="{{errorFlag}}" 
      warning-flag="{{warningFlag}}" 
      message="{{message}}" 
      digits="[[digits]]">
    </number-spinner-validator-plus>
    <message-container 
      error-flag="[[errorFlag]]" 
      warning-flag="[[warningFlag]]"
      message="[[message]]" 
      digits="[[digits]]"
      hide-ok="[[hideEmptyFieldOkMessage()]]">
    </message-container>
  </template>

<!--

  SPINNER ENGINE (Polymer)

--> 
  <script>
    Polymer({

      is: 'number-spinner-plus',

      // READY FUNCTION: If is a discrete spinner, inizialize the index, if is a auto-sorting spinner, sort numbers, and selectRounding
      ready:function() { 
        if(this.discrete){
          this.value=this.values[this.initialIndex];
          this.inputValue=this.values[this.initialIndex];
          this.indexVisualized=this.initialIndex;
          if(this.autoSort) {
            this.values.sort();
          };
        };
        this.selectRounding(this.digits,this.step);
        this.value=d3.format("."+this.digits+"r")(this.value);
      },

      // SELECT ROUNDING: Used if step or digits aren't specified
      selectRounding:function(digits,step)
      {
        if(this.step==null||this.step==undefined) {
          this.step=this.digits;
        }
        if(this.digits==null||this.digits==undefined) {
          // IF DIGITS UNDECLARED, DIGITS=EXP(STEP)+EXP(MAX)
          this.digits=parseInt(this.step.toExponential().substr((this.step.toExponential()).indexOf("e")+2,this.step.toExponential().lenght))
                      +parseInt(this.max.toExponential().substr((this.max.toExponential()).indexOf("e")+2,this.max.toExponential().lenght));
          console.log(this.digits);
        };
      },

      // RESET FLAGS FUNCTION
      resetFlags:function() {
        this.errorFlag=false;
        this.warningFlag=false;
      },

      // FORMAT NUMBER (USED MANY TIMES, ONLY FOR A BETTER READABILITY)
      formatNumber:function(numberToFormat) {
        return parseFloat(d3.format("."+this.digits+"r")(numberToFormat));
      },

      // CONTROLLER on-input: CALL CONTROLLER OF VALIDATOR
      _controlValueInserted:function(e) {
        if(!(isNaN(e.target.value)&&e.target.value==undefined)) {
          this.value=e.target.value; 
        };
        if(this.value!="-"&&this.value!=".") {
          this.$.numberSpinnerValidatorPlus._controlValue(e);
        }
          //IF THERE ARE ONLY MINUS SIMBOL OR DOT, IS OK!
        else{
          this.resetFlags();
        };
      },

      // OPEN DROPDOWN FUNCTIONS
       _openDropdown:function(e) {
        this.toggleAttribute("active",true,this.$.spinner);
      },

      // CLOSE DROPDOWN FUNCTIONS, CONTROL IF TAB IS PRESSED    
      _closeDropdown:function(e) {
        this.toggleAttribute("active",false,this.$.spinner);
        if(e.type="focusout"&&e.type!="mouseout") {
          this._controlValueInserted(e);
        };
      },

      // BUTTON UP FUNCTION
      _up:function(e) {
        // 1. CONTROL ANY PREVIOUS USER INPUT
        this._controlValueInserted(e);
        // 2.1. NOT DISCRETE: Free numbers
        if(!this.discrete) {
          if(this.value!="")
          {
          // If it reaches the MAX with step then sets the value to MAX (do not exceed)
            this.value=this.formatNumber((+this.value+this.step<this.max) ? +this.value+this.step : this.max);
          }
          else{
            this.value=this.max;
          }; 
        }
        // 2.2. DISCRETE: Values fixed 
        else {
          if(this.indexVisualized<this.values.length-1){
            this.value=this.values[this.indexVisualized+1];
            this.indexVisualized=this.indexVisualized+1;
          }
          else{
            // 2.2.1 CIRCULAR FEATURE
            if(this.circular)
            {
              this.value=this.values[0];
              this.indexVisualized=0;
            };
          };    
        };

        // 3. ADD ZEROS
        this.value=d3.format("."+this.digits+"r")(this.value);
        this.toggleAttribute("active",true,this.$.spinner);    
      },

      // BUTTON DOWN FUNCTION, SAME AS UP
      _down:function(e) {
        this._controlValueInserted(e);

        if(!this.discrete) {
          if(this.value!="") {
            this.value=this.formatNumber((+this.value-this.step>this.min) ? +this.value-this.step : this.min);
          }
          else{
            this.value=this.min;
          };      
        }

        else {
          if(this.indexVisualized>0){
            this.value=this.values[this.indexVisualized-1];
            this.indexVisualized=this.indexVisualized-1;
          }

          else{
            if(this.circular)
            {
              this.value=this.values[this.values.length-1];
              this.indexVisualized=this.values.length-1;
            };
          };
        };
        this.value=d3.format("."+this.digits+"r")(this.value);
        this.toggleAttribute("active",true,this.$.spinner);
      },

      // FUNTCION THAT HIDE THE OK-MESSAGE IF THE FIELD IS EMPTY
      hideEmptyFieldOkMessage:function(){
        if(this.value==""){
          return true;
        };
        return false;
      },

      // NUMBER-SPINNER PROPERTIES
      properties: {

          // VALUE
          value:{
            type:Number,
            value:null,
            notify:true,
          },

          values:{
            type:Array,
            value:null,
          },

          // LABEL
          label:{
            type:String,
            value:"Value",
          },

          // MESSAGE
          message:{
            type:String,
            value:null,
          },

          // CONTINUOS PROPERTIES
          min:{
            type:Number,
            value:null,
          },

          max:{
            type:Number,
            value:null,
          },

          min:{
            type:Number,
            value:null,
          },

          max:{
            type:Number,
            value:null,
          },

          step:{
            type:Number,
            value:1, 
          },

          digits:{
            type:Number,
            value:null,
          },

          // DISCRETE PROPERTIES
          indexVisualized:{
            type:Number,
            value:0,
            notify:true,
          },

          initialIndex:{
            type:Number,
            value:0,
          },

          circular:{
            type:Boolean,
            value:false,
          },

          autoSort:{
            type:Boolean,
            value:false,
          },

          // FLAGS
          allowed:{
            type:Boolean,
            value:true,
          },

          discrete:{
            type:Boolean,
            value:false,
          },

          errorFlag:{
            type:Boolean,
            value:false,
          },

          warningFlag:{
            type:Boolean,
            value:false,
          },
      },
    });
  </script>
</dom-module>